<!doctype html>
<html lang="es"><head>
  <meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Resumen mensual</title><script src="https://cdn.tailwindcss.com"></script>
</head><body class="bg-gray-50 text-gray-900">
<div class="max-w-2xl mx-auto p-4">
  <header class="flex items-center justify-between mb-3">
    <h1 class="text-xl font-bold">Resumen mensual</h1>
    <a href="/" class="underline text-blue-600 text-sm">‚Üê Volver</a>
  </header>

  <div class="grid grid-cols-3 gap-3 mb-4">
    <div class="bg-white p-3 rounded shadow"><div class="text-sm text-gray-500">Registros</div><div id="count" class="text-2xl font-semibold">0</div></div>
    <div class="bg-white p-3 rounded shadow"><div class="text-sm text-gray-500">üü¢ Favorables</div><div id="green" class="text-2xl font-semibold">0</div></div>
    <div class="bg-white p-3 rounded shadow"><div class="text-sm text-gray-500">üî¥ Desfavorables</div><div id="red" class="text-2xl font-semibold">0</div></div>
  </div>

  <div class="bg-white p-3 rounded shadow mb-4">
    <div class="text-sm font-semibold mb-2">Distribuci√≥n por tipo</div>
    <div id="perType" class="text-sm text-gray-700">‚Äî</div>
  </div>

  <div class="bg-white p-3 rounded shadow">
    <div class="text-sm font-semibold mb-2">Detalle por d√≠a</div>
    <div id="byDay" class="text-sm"></div>
  </div>
</div>

<script>
async function load() {
  const res = await fetch('/registros');
  const data = await res.json();
  const items = data.items || [];
  document.getElementById('count').textContent = items.length;
  document.getElementById('green').textContent = items.filter(x => x.color === 'üü¢').length;
  document.getElementById('red').textContent = items.filter(x => x.color === 'üî¥').length;

  const perType = {};
  for (const r of items) { const t = r.tipo || 'Sin tipo'; perType[t] = (perType[t] || 0) + 1; }
  document.getElementById('perType').textContent = Object.entries(perType).map(([k,v]) => `${k}: ${v}`).join(' ¬∑ ') || '‚Äî';

  const byDayMap = {};
  for (const r of items) { const d = r.fecha_iso || '‚Äî'; (byDayMap[d] = byDayMap[d] || []).push(r); }
  const container = document.getElementById('byDay'); container.innerHTML = '';
  Object.keys(byDayMap).sort().forEach(d => {
    const list = byDayMap[d];
    const rows = list.map(r => `
      <tr class="border-b">
        <td class="py-1 pr-2 whitespace-nowrap">${r.hora||''}</td>
        <td class="py-1 pr-2">${r.tipo||''}</td>
        <td class="py-1 pr-2">${r.descripcion||''}</td>
        <td class="py-1 pr-2">${r.color||''}</td>
        <td class="py-1 pr-2">${r.impacto||''}</td>
      </tr>`).join('');
    const html = `
      <div class="mb-3"><div class="font-semibold mb-1">${d}</div>
      <div class="overflow-x-auto"><table class="min-w-full text-sm">
        <thead class="bg-gray-100"><tr>
          <th class="text-left py-1 pr-2">Hora</th>
          <th class="text-left py-1 pr-2">Tipo</th>
          <th class="text-left py-1 pr-2">Descripci√≥n</th>
          <th class="text-left py-1 pr-2">Color</th>
          <th class="text-left py-1 pr-2">Impacto</th>
        </tr></thead><tbody>${rows}</tbody></table></div></div>`;
    const div = document.createElement('div'); div.innerHTML = html; container.appendChild(div.firstElementChild);
  });
}
load();
</script>
</body></html>
